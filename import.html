<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ê¸¸ë“œ ë°ì´í„° ì¼ê´„ ì—…ë¡œë“œ (guildConfigs/default)</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #111827;
        color: #e5e7eb;
        padding: 24px;
      }
      h1 {
        margin-bottom: 8px;
      }
      .card {
        background: #1f2937;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
      }
      label {
        display: block;
        margin-bottom: 8px;
      }
      input[type="file"] {
        display: block;
        margin-top: 4px;
      }
      button {
        margin-top: 12px;
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      button#upload-btn {
        background: #2563eb;
        color: white;
      }
      button#upload-btn:disabled {
        opacity: 0.5;
        cursor: default;
      }
      pre {
        background: #000000;
        padding: 12px;
        border-radius: 6px;
        max-height: 400px;
        overflow: auto;
        font-size: 12px;
        white-space: pre-wrap;
        word-break: break-all;
      }
      a {
        color: #93c5fd;
      }
    </style>
  </head>
  <body>
    <h1>ê¸¸ë“œ ë°ì´í„° CSV ì—…ë¡œë“œ</h1>
    <p>
      ì´ í˜ì´ì§€ëŠ” <code>guildConfigs/default</code> ë¬¸ì„œë¥¼
      <strong>í†µì§¸ë¡œ ë®ì–´ì“°ê¸°</strong> í•©ë‹ˆë‹¤. (ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì‚¬ìš© ì•ˆ í•¨)
    </p>

    <div class="card">
      <h2>1. CSV ì„ íƒ</h2>
      <label>
        members.csv (UTF-8):
        <input type="file" id="members-file" accept=".csv" />
      </label>
      <label>
        scores.csv (UTF-8):
        <input type="file" id="scores-file" accept=".csv" />
      </label>
      <button id="upload-btn">ì—…ë¡œë“œ ì‹œì‘</button>
      <p style="font-size: 12px; color: #9ca3af; margin-top: 8px">
        * ì—‘ì…€ì—ì„œ ì €ì¥ ì‹œ í˜•ì‹:
        <strong>â€œCSV UTF-8(ì‰¼í‘œë¡œ ë¶„ë¦¬)(*.csv)â€</strong> ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. (í•œê¸€
        ê¹¨ì§ ë°©ì§€)
      </p>
      <p style="font-size: 12px; color: #f97373">
        * ì—…ë¡œë“œí•˜ë©´ ê¸°ì¡´ <code>guildConfigs/default</code> ì˜ members/thresholdê°€
        ëª¨ë‘ ë®ì–´ì¨ì§‘ë‹ˆë‹¤.
      </p>
    </div>

    <div class="card">
      <h2>ë¡œê·¸</h2>
      <pre id="log"></pre>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBKvKAPMwG0FJQj7n3OmX7Ld3sUrPpqtQA",
        authDomain: "sena-guild-tool.firebaseapp.com",
        projectId: "sena-guild-tool",
        storageBucket: "sena-guild-tool.firebasestorage.app",
        messagingSenderId: "93989921944",
        appId: "1:93989921944:web:2b3aa298d6f97481411ced",
        measurementId: "G-5YSK93P66B",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const remoteDocRef = doc(db, "guildConfigs", "default");

      const logEl = document.getElementById("log");
      const uploadBtn = document.getElementById("upload-btn");

      function log(msg) {
        const time = new Date().toLocaleTimeString("ko-KR", {
          hour12: false,
        });
        logEl.textContent += `[${time}] ${msg}\n`;
        logEl.scrollTop = logEl.scrollHeight;
        console.log(msg);
      }

      function parseCSV(text) {
        return text
          .split(/\r?\n/)
          .map((line) => line.trim())
          .filter((line) => line.length > 0)
          .map((line) => line.split(",").map((s) => s.trim()));
      }

      function parseNumberOrNull(v) {
        if (v == null || v === "") return null;
        const n = Number(String(v).replace(/,/g, ""));
        if (!Number.isFinite(n) || n <= 0) return null;
        return n;
      }

      function defaultWeekScores() {
        return {
          mon: null,
          tue: null,
          wed: null,
          thu: null,
          fri: null,
          sat: null,
          sun: null,
        };
      }

      async function readFileAsText(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(reader.error);
          reader.readAsText(file, "utf-8"); // í•œê¸€ ê¹¨ì§ ë°©ì§€
        });
      }

      async function handleUpload() {
        const membersFile = document.getElementById("members-file").files[0];
        const scoresFile = document.getElementById("scores-file").files[0];

        if (!membersFile || !scoresFile) {
          alert("members.csv ì™€ scores.csv ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        uploadBtn.disabled = true;
        log("=== ì—…ë¡œë“œ ì‹œì‘ ===");

        try {
          // ê¸°ì¡´ threshold ê°€ì ¸ì˜¤ê¸° (ìˆìœ¼ë©´ ìœ ì§€)
          let threshold = 300000;
          try {
            const snap = await getDoc(remoteDocRef);
            if (snap.exists()) {
              const data = snap.data() || {};
              if (
                typeof data.threshold === "number" &&
                data.threshold >= 0
              ) {
                threshold = data.threshold;
              }
            }
          } catch (e) {
            log("ê¸°ì¡´ threshold ì¡°íšŒ ì‹¤íŒ¨ (ë¬´ì‹œ ê°€ëŠ¥): " + e.message);
          }

          // 1) members.csv íŒŒì‹±
          log(`members.csv ì½ëŠ” ì¤‘: ${membersFile.name}`);
          const membersText = await readFileAsText(membersFile);
          const membersRows = parseCSV(membersText);
          if (membersRows.length < 2) {
            throw new Error("members.csv ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
          }
          const mHeader = membersRows[0];
          const mData = membersRows.slice(1);

          const colIndex = {
            name: mHeader.indexOf("name"),
            role: mHeader.indexOf("role"),
            joinDate: mHeader.indexOf("joinDate"),
            status: mHeader.indexOf("status"),
            leaveType: mHeader.indexOf("leaveType"),
            leaveWeekId: mHeader.indexOf("leaveWeekId"),
          };

          if (colIndex.name === -1) {
            throw new Error(
              "members.csv í—¤ë”ì— name ì»¬ëŸ¼ì´ í•„ìš”í•©ë‹ˆë‹¤. (ì˜ˆ: name,role,joinDate,...)",
            );
          }

          const memberMap = new Map(); // key: name

          mData.forEach((row, i) => {
            const rowNo = i + 2; // 1í–‰ í—¤ë”ë¼ì„œ
            const name = row[colIndex.name]?.trim();
            if (!name) {
              log(`âš  [í–‰ ${rowNo}] name ì´ ë¹„ì–´ ìˆì–´ ê±´ë„ˆëœ€`);
              return;
            }

            const role =
              colIndex.role === -1 ? "ê¸¸ë“œì›" : row[colIndex.role]?.trim() || "ê¸¸ë“œì›";
            const joinDate =
              colIndex.joinDate === -1
                ? null
                : row[colIndex.joinDate]?.trim() || null;
            const statusRaw =
              colIndex.status === -1 ? "" : row[colIndex.status]?.trim() || "";
            const status =
              statusRaw === "left" || statusRaw === "íƒˆí‡´" ? "left" : "active";
            const leaveType =
              colIndex.leaveType === -1
                ? null
                : row[colIndex.leaveType]?.trim() || null;
            const leaveWeekId =
              colIndex.leaveWeekId === -1
                ? null
                : row[colIndex.leaveWeekId]?.trim() || null;

            const base = {
              id: Date.now() + rowNo,
              name,
              role,
              joinDate: joinDate || "2025-01-01",
              status,
              leaveType: leaveType || null,
              leaveWeekId: leaveWeekId || null,
              scoresByWeek: {},
              defenseDeckByWeek: {},
            };

            memberMap.set(name, base);
            log(`âœ… [í–‰ ${rowNo}] ë©¤ë²„ ê¸°ë³¸ì •ë³´ ë¡œë“œ: ${name}`);
          });

          // 2) scores.csv íŒŒì‹±
          log(`scores.csv ì½ëŠ” ì¤‘: ${scoresFile.name}`);
          const scoresText = await readFileAsText(scoresFile);
          const scoresRows = parseCSV(scoresText);
          if (scoresRows.length < 2) {
            throw new Error("scores.csv ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
          }

          const sHeader = scoresRows[0];
          const sData = scoresRows.slice(1);

          const sIndex = {
            name: sHeader.indexOf("name"),
            weekId: sHeader.indexOf("weekId"),
            mon: sHeader.indexOf("mon"),
            tue: sHeader.indexOf("tue"),
            wed: sHeader.indexOf("wed"),
            thu: sHeader.indexOf("thu"),
            fri: sHeader.indexOf("fri"),
            sat: sHeader.indexOf("sat"),
            sun: sHeader.indexOf("sun"),
          };

          if (sIndex.name === -1 || sIndex.weekId === -1) {
            throw new Error(
              "scores.csv í—¤ë”ì— name, weekId ì»¬ëŸ¼ì´ í•„ìš”í•©ë‹ˆë‹¤. (ì˜ˆ: name,weekId,mon,tue,...)",
            );
          }

          sData.forEach((row, i) => {
            const rowNo = i + 2;
            const name = row[sIndex.name]?.trim();
            const weekId = row[sIndex.weekId]?.trim();
            if (!name || !weekId) {
              log(
                `âš  [í–‰ ${rowNo}] name ë˜ëŠ” weekId ê°€ ë¹„ì–´ ìˆì–´ ê±´ë„ˆëœ€ (name=${name}, weekId=${weekId})`,
              );
              return;
            }

            if (!memberMap.has(name)) {
              // members.csv ì— ì—†ëŠ” ì´ë¦„ì´ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ìƒì„±
              log(
                `âš  [í–‰ ${rowNo}] members.csv ì— ì—†ëŠ” ì´ë¦„ì´ë¼ ìƒˆ ë©¤ë²„ ìƒì„±: ${name}`,
              );
              memberMap.set(name, {
                id: Date.now() + 100000 + rowNo,
                name,
                role: "ê¸¸ë“œì›",
                joinDate: weekId,
                status: "active",
                leaveType: null,
                leaveWeekId: null,
                scoresByWeek: {},
                defenseDeckByWeek: {},
              });
            }

            const member = memberMap.get(name);
            if (!member.scoresByWeek) member.scoresByWeek = {};
            if (!member.scoresByWeek[weekId]) {
              member.scoresByWeek[weekId] = defaultWeekScores();
            }

            const target = member.scoresByWeek[weekId];

            ["mon", "tue", "wed", "thu", "fri", "sat", "sun"].forEach((day) => {
              const idx = sIndex[day];
              if (idx === -1) return;
              const val = parseNumberOrNull(row[idx]);
              if (val != null) {
                target[day] = val;
              }
            });

            log(`âœ… [í–‰ ${rowNo}] ì ìˆ˜ ë°˜ì˜: ${name} / ${weekId}`);
          });

          const finalMembers = Array.from(memberMap.values());
          log(
            `=== Firestore ì €ì¥ ì¤€ë¹„: ë©¤ë²„ ${finalMembers.length}ëª…, threshold=${threshold} ===`,
          );

          await setDoc(remoteDocRef, {
            members: finalMembers,
            threshold,
            updatedAt: serverTimestamp(),
          });

          log("ğŸ‰ Firestore guildConfigs/default ë¬¸ì„œ ì €ì¥ ì™„ë£Œ!");
          log("index.html ì„ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì—…ë¡œë“œí•œ ë°ì´í„°ê°€ ë°”ë¡œ ë³´ì…ë‹ˆë‹¤.");
        } catch (e) {
          console.error(e);
          log("âŒ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜: " + e.message);
          alert("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
        } finally {
          uploadBtn.disabled = false;
          log("=== ì—…ë¡œë“œ ì‘ì—… ì¢…ë£Œ ===");
        }
      }

      uploadBtn.addEventListener("click", handleUpload);

      log("Firebase ì´ˆê¸°í™” ì™„ë£Œ. CSVë¥¼ ì„ íƒí•œ ë’¤ [ì—…ë¡œë“œ ì‹œì‘]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
    </script>
  </body>
</html>
